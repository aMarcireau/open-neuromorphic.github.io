{{- $supporters := site.Data.supporters.foundational -}}

{{- if $supporters -}}
{{- /* --- Pre-calculation of contributions for bubbles --- */ -}}
{{- $contributionsMap := dict -}}
{{- $contentTypes := slice "workshops" "hacking-hours" -}}
{{- $contentSections := slice "blog" -}}
{{- $allRelevantContent := where site.RegularPages "Type" "in" $contentTypes | union (where site.RegularPages "Section" "in" $contentSections) -}}

{{- range $content := $allRelevantContent -}}
{{- with $content.Params.software_tags -}}
{{- range . -}}
{{- $slug := . -}}
{{- $counts := index $contributionsMap $slug | default (dict "Workshops" 0 "Hacking Hours" 0 "Blogs" 0) -}}
{{- $type_key := "" -}}
{{- if eq $content.Type "workshops" -}}{{- $type_key = "Workshops" -}}
{{- else if eq $content.Type "hacking-hours" -}}{{- $type_key = "Hacking Hours" -}}
{{- else if eq $content.Section "blog" -}}{{- $type_key = "Blogs" -}}{{- end -}}

{{- if ne $type_key "" -}}
{{- $counts = merge $counts (dict $type_key (add (index $counts $type_key) 1)) -}}
{{- $contributionsMap = merge $contributionsMap (dict $slug $counts) -}}
{{- end -}}
{{- end -}}
{{- end -}}
{{- end -}}

<div class="community-partners-section bg-gray-50 dark:bg-darkmode-theme-dark pt-16 pb-10 relative">
  <div class="container mx-auto px-6">
    <div class="partners-slider-wrapper mt-[120px]">
      <div class="partners-slider whitespace-nowrap">
        <div class="partners-track inline-flex items-center pt-8">
          {{- /* Duplicate the logos for a seamless scroll animation effect */ -}}
          {{- range (seq 2) -}}
          {{- range $supporter := $supporters -}}
          {{- /* Determine what to display: the hero override or the default */ -}}
          {{- $display_name := $supporter.name -}}
          {{- $display_page_path := $supporter.page_path -}}
          {{- if $supporter.hero_display -}}
          {{- $display_name = $supporter.hero_display.name -}}
          {{- $display_page_path = $supporter.hero_display.page_path -}}
          {{- end -}}

          {{- $page := "" -}}
          {{- with $display_page_path -}}
          {{- $page = site.GetPage . -}}
          {{- end -}}

          {{- if $page -}}
          {{- $slug := "" -}}
          {{- if $page.File -}}{{- $slug = path.Base $page.File.Dir -}}{{- end -}}

          {{- /* Bubble logic remains the same, using the page slug */ -}}
          {{- $data_attr := "" -}}
          {{- with index $contributionsMap $slug -}}
          {{- $contribution_strings := slice -}}
          {{- if gt .Workshops 0 -}}{{- $contribution_strings = $contribution_strings | append (printf "Workshops: %d" .Workshops) -}}{{- end -}}
          {{- if gt (index . "Hacking Hours") 0 -}}{{- $contribution_strings = $contribution_strings | append (printf "Hacking Hours: %d" (index . "Hacking Hours")) -}}{{- end -}}
          {{- if gt .Blogs 0 -}}{{- $contribution_strings = $contribution_strings | append (printf "Blogs: %d" .Blogs) -}}{{- end -}}
          {{- if gt (len $contribution_strings) 0 -}}
          {{- $data_attr = printf `data-contributions="%s"` (delimit $contribution_strings "<br>") | safeHTMLAttr -}}
          {{- end -}}
          {{- end -}}

          {{- /* Image and Link logic */ -}}
          {{- with $supporter.logo -}}
          {{- $logo_resource := "" -}}
          {{- /* Check for logo in the actual page bundle (e.g., nirtorch's page) */ -}}
          {{- with $page.Resources.GetMatch . -}}
          {{- $logo_resource = . -}}
          {{- end -}}

          {{- /* Fallback to check assets folder */ -}}
          {{- if not $logo_resource -}}
          {{- $logo_from_assets := resources.Get . -}}
          {{- if $logo_from_assets -}}
          {{- $logo_resource = $logo_from_assets -}}
          {{- end -}}
          {{- end -}}

          {{- if $logo_resource -}}
          <a href="{{ $page.RelPermalink }}" title="{{ $display_name }}" class="partner-logo-link px-6 py-2 flex-shrink-0" data-project-name="{{ $display_name }}" data-project-description="{{ $page.Description }}" {{ $data_attr }}>
            {{- $logo_img := $logo_resource.Fit "150x50 Lanczos" -}}
            <img src="{{ $logo_img.RelPermalink }}" alt="{{ $display_name }} logo" class="partner-logo h-10 w-auto max-w-[150px] object-contain {{ if $supporter.dark_logo_invert }}dark:invert{{ end }}">
          </a>
          {{- end -}}
          {{- end -}}
          {{- end -}}
          {{- end -}}
          {{- end -}}
        </div>
      </div>
    </div>

    <div class="mt-2 text-center">
      <p class="byline-paragraph font-secondary text-lg text-gray-600 dark:text-gray-400">
        In collaboration with our <a href="{{ "supporters/" | relLangURL }}" class="byline-link font-semibold">foundational supporters</a> from the open-source ecosystem.
      </p>
    </div>

  </div>

  <div class="bubbles-container"></div>
</div>
{{- end -}}
